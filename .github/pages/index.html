<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>Docs - Async Packet Test</title> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>Docs | Async Packet Test</title> <meta name="generator" content="Jekyll v4.2.1" /> <meta property="og:title" content="Docs" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Python library for testing the contents or other “expectations” on future packets." /> <meta property="og:description" content="Python library for testing the contents or other “expectations” on future packets." /> <link rel="canonical" href="/" /> <meta property="og:url" content="/" /> <meta property="og:site_name" content="Async Packet Test" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Docs" /> <script type="application/ld+json"> {"description":"Python library for testing the contents or other “expectations” on future packets.","@type":"WebSite","url":"/","headline":"Docs","name":"Async Packet Test","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/" class="site-title lh-tight"> Async Packet Test </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"> <!-- figure out set active?? --> <li class="nav-list-item"> <a href="#overview" class="nav-list-link">Overview</a> </li> <!-- figure out set active?? --> <li class="nav-list-item"> <a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a> <a href="#installation" class="nav-list-link">Installation</a> <ul class="nav-list "> <li class="nav-list-item"> <a href="#permissions" class="nav-list-link">Permissions</a> </li> </ul> </li> <!-- figure out set active?? --> <li class="nav-list-item"> <a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a> <a href="#usage" class="nav-list-link">Usage</a> <ul class="nav-list "> <li class="nav-list-item"> <a href="#test-context" class="nav-list-link">Test Context</a> </li> <li class="nav-list-item"> <a href="#test-predicates" class="nav-list-link">Test Predicates</a> </li> <li class="nav-list-item"> <a href="#writing-tests" class="nav-list-link">Writing Tests</a> </li> <li class="nav-list-item"> <a href="#pytest-integration" class="nav-list-link">Pytest Integration</a> </li> <li class="nav-list-item"> <a href="#built-in-predicates" class="nav-list-link">Built-in Predicates</a> </li> <li class="nav-list-item"> <a href="#writing-custom-predicates" class="nav-list-link">Writing Custom Predicates</a> </li> </ul> </li> </ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Async Packet Test" aria-label="Search Async Packet Test" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div id="main-content-wrap" class="main-content-wrap"> <div id="main-content" class="main-content" role="main"> <p style="margin: 0px auto; width: 50%"><img src="/logo.png" alt="Logo" /></p> <h1 style="text-align: center" id="asynchronous-packet-testing"> <a href="#asynchronous-packet-testing" class="anchor-heading" aria-labelledby="asynchronous-packet-testing"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Asynchronous Packet Testing </h1> <p style="text-align: center" class="fs-6 fw-300">Python library for writing simple and human readable tests for future expected packets.</p><hr /> <h2 id="overview"> <a href="#overview" class="anchor-heading" aria-labelledby="overview"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Overview </h2> <p>Async Packet Test is a Python library based on <code class="language-plaintext highlighter-rouge">scapy</code> that can test the contents of yet to be received packets, as well as providing <code class="language-plaintext highlighter-rouge">pytest</code> integration for doing so.</p> <p>The concept came from writing packet processing pipelines in the <a href="">P4 programming language</a>, where I wanted to write tests for end to end changes to and the receipt of packets, treating the pipeline itself as a closed and mysterious box. That and the <a href="">Packet Test Framework</a> I found to be highly coupled and far too detailed/verbose for writing simple tests.</p> <p>The concept is that, we have an expectation that at some point in the future, we may expect to receive (or explicitly not receive!) a packet on some network interface that matches some condition or property.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">async_packet_test.context</span> <span class="kn">import</span> <span class="n">make_pytest_context</span>
<span class="kn">from</span> <span class="nn">async_packet_test.predicates</span> <span class="kn">import</span> <span class="n">saw_dst_mac</span>

<span class="n">context</span> <span class="o">=</span> <span class="n">make_pytest_context</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">test_saw_mac_broadcast</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">"eth0"</span><span class="p">,</span> <span class="n">saw_dst_mac</span><span class="p">(</span><span class="s">"ff:ff:ff:ff:ff:ff"</span><span class="p">))</span>
    <span class="n">result</span><span class="p">.</span><span class="n">assert_true</span><span class="p">()</span>
</code></pre></div></div> <!-- That is to say, at some point in the future we expect that the `eth0` network interface should see [MAC]() broadcast packet. ```python from async_packet_test.context import TestContext from scapy.all import Ether, ICMP, IP, sendp context = TestContext() pkt = Ether()/IP(src='10.0.0.1', dst='10.0.0.2')/ICMP() test = context.expect('eth0', saw_packet_equals_sent(pkt)) # Send packet sendp(pkt, iface='eth0') assert(test.result() == True) ``` --> <h2 id="installation"> <a href="#installation" class="anchor-heading" aria-labelledby="installation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Installation </h2> <p>This is not currently on <a href="https://pypi.org/">PyPI</a>, and has to be installed directly from the repository.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/CommitThis/async-packet-test
<span class="nb">cd </span>async-packet-test <span class="o">&amp;&amp;</span> pip <span class="nb">install</span> <span class="nb">.</span>
</code></pre></div></div> <h3 id="permissions"> <a href="#permissions" class="anchor-heading" aria-labelledby="permissions"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Permissions </h3> <p>If you wish to run the tests without using sudo (and the inevitable environment preservation things you might have to do), you can do so, but you should consider the security implications beforehand.</p> <p>In order to open network sockets, a non-admin user can only do so if the executable that does so has the appropriate permissions (called <a href="https://man7.org/linux/man-pages/man7/capabilities.7.html">capabilities</a>).</p> <p>In this case the capability is <code class="language-plaintext highlighter-rouge">CAP_NET_RAW</code></p> <p>It would likely be considered unwise to apply such capabilities directly to the system installed Python or <a href="https://docs.pytest.org/en/6.2.x/">pytest</a>. An alternative approach would be to install it into a virtual Python environment, which has taken copies of the Python executables:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python <span class="nt">-m</span> venv <span class="nt">--copies</span> .venv 
<span class="nb">sudo </span>setcap CAP_NET_RAW+eip .venv/bin/python
<span class="nb">sudo </span>setcap CAP_NET_RAW+eip .venv/bin/python3
<span class="nb">sudo </span>setcap CAP_NET_RAW+eip .venv/bin/pytest
</code></pre></div></div> <blockquote> <p><code class="language-plaintext highlighter-rouge">setcap</code>… sets capabilities. <code class="language-plaintext highlighter-rouge">+eip</code> defines the “capability sets”; <code class="language-plaintext highlighter-rouge">CAP_NET_RAW</code> is added to the executables effective (<code class="language-plaintext highlighter-rouge">e</code>) and permitted sets (<code class="language-plaintext highlighter-rouge">p</code>), and that any further process forks and threads will inherit (<code class="language-plaintext highlighter-rouge">i</code>) the capability set of the original executable. That’s my understanding of it anyway.</p> </blockquote> <h2 id="usage"> <a href="#usage" class="anchor-heading" aria-labelledby="usage"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Usage </h2> <p>There are three main components of the library you will work with:</p> <ol> <li>The <code class="language-plaintext highlighter-rouge">TestContext</code>. This is an object that is responsible for starting “expectations” on a specific network interface through the <code class="language-plaintext highlighter-rouge">expect</code> method, as well as manage their lifetime;</li> <li>Test predicates, which are passed to an <code class="language-plaintext highlighter-rouge">expect</code> call and are the things that perform the tests on packets.</li> <li>Finally, the test result.</li> </ol> <h3 id="test-context"> <a href="#test-context" class="anchor-heading" aria-labelledby="test-context"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Test Context </h3> <p>The <code class="language-plaintext highlighter-rouge">TestContext</code> is used to start and manage running tests/expectations. It takes no constructor arguments, and it’s interface is simple:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TestContext</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">expect</span><span class="p">(</span><span class="bp">self</span>
            <span class="n">iface</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>           <span class="c1"># Network interface to bind to
</span>            <span class="n">predicate</span><span class="p">:</span> <span class="n">Predicate</span><span class="p">,</span> <span class="c1"># ... uh.. the test predicate
</span>            <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>       <span class="c1"># Number of seconds before test is cancelled
</span>            <span class="n">count</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>          <span class="c1"># Number of packets before test is cancelled
</span>        <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
</code></pre></div></div> <p>That’s all there is to it.</p> <blockquote> <p>There is a <code class="language-plaintext highlighter-rouge">monitor</code> method, but it is not well tested, it is functionality that can be achieved using an ordinary <code class="language-plaintext highlighter-rouge">scapy.AsyncSniffer</code> and may be removed in the future. It is therefore not recommended to be used.</p> </blockquote> <h3 id="test-predicates"> <a href="#test-predicates" class="anchor-heading" aria-labelledby="test-predicates"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Test Predicates </h3> <p>Predicates have been named to read naturally in English (even if it isn’t my strong suit) and read well in the context of the test. Even though they are technically classes, in spite of <code class="language-plaintext highlighter-rouge">PEP</code> , they are written in the underscore style. This is because they are used in a context where they could be perceived as functions, and that lower case anything is easier to read and above all, in my opinion (outside testing an outcome), unit tests should be comprehensible. [[ citation needed ]]</p> <p>Because they are testing something that <em>may</em> happen in the future, they cannot be evaluated immediately, and therefore their use may not be as obvious as other testing frameworks.</p> <p>As an example, we might want to test if a specific port saw a packet with a particular MAC address.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_saw_mac_address</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="n">dst_mac</span> <span class="o">=</span> <span class="s">'ab:ab:ab:ab:ab:ab'</span>
    <span class="n">iface</span> <span class="o">=</span> <span class="s">'veth0'</span>
    <span class="n">future</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="n">iface</span><span class="p">,</span> <span class="n">saw_dst_mac</span><span class="p">(</span><span class="n">dst_mac</span><span class="p">))</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">future</span><span class="p">.</span><span class="n">result</span><span class="p">()</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span>
</code></pre></div></div> <p>It may be obvious, but what this is saying that we want to test that at some point in the future that <code class="language-plaintext highlighter-rouge">veth0</code> will see the supplied MAC adress. The <code class="language-plaintext highlighter-rouge">future</code> from the <code class="language-plaintext highlighter-rouge">expect</code> call represents the outcome of the test. Consequently, when retrieving the result, this call will block until the test completes.</p> <h3 id="writing-tests"> <a href="#writing-tests" class="anchor-heading" aria-labelledby="writing-tests"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Writing Tests </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">async_packet_test.context</span> <span class="kn">import</span> <span class="n">TestContext</span>
<span class="kn">from</span> <span class="nn">scapy.all</span> <span class="kn">import</span> <span class="n">Ether</span><span class="p">,</span> <span class="n">ICMP</span><span class="p">,</span> <span class="n">IP</span><span class="p">,</span> <span class="n">sendp</span>

<span class="n">context</span> <span class="o">=</span> <span class="n">TestContext</span><span class="p">()</span>
<span class="n">pkt</span> <span class="o">=</span> <span class="n">Ether</span><span class="p">()</span><span class="o">/</span><span class="n">IP</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="s">'10.0.0.1'</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="s">'10.0.0.2'</span><span class="p">)</span><span class="o">/</span><span class="n">ICMP</span><span class="p">()</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">'eth0'</span><span class="p">,</span> <span class="n">saw_packet_equals_sent</span><span class="p">(</span><span class="n">pkt</span><span class="p">))</span>

<span class="c1"># Send packet
</span><span class="n">sendp</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">iface</span><span class="o">=</span><span class="s">'eth0'</span><span class="p">)</span>

<span class="k">assert</span><span class="p">(</span><span class="n">test</span><span class="p">.</span><span class="n">result</span><span class="p">())</span>
</code></pre></div></div> <p>Predicates can be passed to an expect call as either a class or constructed object. This is mainly for terseness; if a predicate doesn’t accept any constructor arguments, you can pass it’s class and an object of that type will be constructed for you:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">context</span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">'eth0'</span><span class="p">,</span> <span class="n">received_packet</span><span class="p">)</span>
</code></pre></div></div> <p>There are a couple of different ways assertions can be defined:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">assert</span><span class="p">(</span><span class="n">test</span><span class="p">.</span><span class="n">result</span><span class="p">()</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span>
<span class="k">assert</span><span class="p">(</span><span class="n">test</span><span class="p">.</span><span class="n">result</span><span class="p">()</span> <span class="o">==</span> <span class="mi">42</span><span class="p">)</span>
<span class="n">test</span><span class="p">.</span><span class="n">assert_true</span><span class="p">()</span>
<span class="n">test</span><span class="p">.</span><span class="n">assert_false</span><span class="p">()</span>
<span class="n">test</span><span class="p">.</span><span class="n">assert_value</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
</code></pre></div></div> <p>For further examples, look at the <a href="https://github.com/CommitThis/async-packet-test/blob/main/test/test_predicates.py">unit tests</a>.</p> <h3 id="pytest-integration"> <a href="#pytest-integration" class="anchor-heading" aria-labelledby="pytest-integration"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Pytest Integration </h3> <p>Pytest integration is achieved by returning a test fixture that wraps a test context.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">async_packet_test.context</span> <span class="kn">import</span> <span class="n">make_pytest_context</span>
<span class="kn">from</span> <span class="nn">async_packet_test.predicates</span> <span class="kn">import</span> <span class="n">saw_dst_mac</span>

<span class="n">context</span> <span class="o">=</span> <span class="n">make_pytest_context</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">test_saw_mac_broadcast</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">"eth0"</span><span class="p">,</span> <span class="n">saw_dst_mac</span><span class="p">(</span><span class="s">"ff:ff:ff:ff:ff:ff"</span><span class="p">))</span>
    <span class="n">result</span><span class="p">.</span><span class="n">assert_true</span><span class="p">()</span>
</code></pre></div></div> <p>Assuming that <a href="#permissions">permissions</a> have been setup correctly, and the library has been installed you should then be able to run</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pytest
</code></pre></div></div> <p>In you project.</p> <h3 id="built-in-predicates"> <a href="#built-in-predicates" class="anchor-heading" aria-labelledby="built-in-predicates"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Built-in Predicates </h3> <ul> <li><code class="language-plaintext highlighter-rouge">received_packet</code></li> <li><code class="language-plaintext highlighter-rouge">timed_out</code></li> <li><code class="language-plaintext highlighter-rouge">saw_src_mac</code></li> <li><code class="language-plaintext highlighter-rouge">did_not_see_src_mac</code></li> <li><code class="language-plaintext highlighter-rouge">saw_dst_mac</code></li> <li><code class="language-plaintext highlighter-rouge">did_not_see_dst_mac</code></li> <li><code class="language-plaintext highlighter-rouge">saw_vlan_tag</code></li> <li><code class="language-plaintext highlighter-rouge">did_not_see_vlan_tag</code></li> <li><code class="language-plaintext highlighter-rouge">did_not_see_vlan</code></li> <li><code class="language-plaintext highlighter-rouge">saw_packet_equaling</code></li> <li><code class="language-plaintext highlighter-rouge">did_not_see_packet_equaling</code></li> <li><code class="language-plaintext highlighter-rouge">packet_count_was</code></li> <li><code class="language-plaintext highlighter-rouge">packet_count_was_less_than</code></li> <li><code class="language-plaintext highlighter-rouge">packet_count</code></li> <li><code class="language-plaintext highlighter-rouge">received_count_of</code></li> </ul> <h3 id="writing-custom-predicates"> <a href="#writing-custom-predicates" class="anchor-heading" aria-labelledby="writing-custom-predicates"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Writing Custom Predicates </h3> <p>This is relatively easy. The predicates are objects that test incoming packets, and are able to carry state from one evaluation from the next. The base test is as follows:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">async_packet_test</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">on_packet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkt</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">stop_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkt</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">on_finish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timed_out</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div></div> <ul> <li><code class="language-plaintext highlighter-rouge">on_packet</code> receives avery packet. It is there for updating state.</li> <li> <p><code class="language-plaintext highlighter-rouge">stop_condition</code> is the to notify the test manager that the test has completed</p> </li> <li><code class="language-plaintext highlighter-rouge">on_finish</code> reports the result back to the manager, and ultimately the future given back to the user.</li> </ul> <p>Carrying on with our previous example <code class="language-plaintext highlighter-rouge">saw_dst_mac</code> , the predicate is constructed as follows:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">saw_src_mac</span><span class="p">(</span><span class="n">async_packet_test</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mac</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_mac</span> <span class="o">=</span> <span class="n">mac</span>

    <span class="k">def</span> <span class="nf">stop_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkt</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pkt</span><span class="p">.</span><span class="n">haslayer</span><span class="p">(</span><span class="n">Ether</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pkt</span><span class="p">[</span><span class="n">Ether</span><span class="p">].</span><span class="n">src</span> <span class="o">==</span> <span class="bp">self</span><span class="p">.</span><span class="n">_mac</span>

    <span class="k">def</span> <span class="nf">on_finish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timed_out</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">timed_out</span>
</code></pre></div></div> <p>This is straightforward as no state is needed between packets; we only need to test each individual packet for the supplied MAC address. As soon as that MAC is seen, the test will terminate and <code class="language-plaintext highlighter-rouge">on_finish</code> will be called. Ultimately, the only thing that needs to be returned is whether the test timed out, if it didn’t time out, the stop condition will never have returned <code class="language-plaintext highlighter-rouge">True</code> .</p> <blockquote> <p><code class="language-plaintext highlighter-rouge">on_finish</code> could have been written by default to test whether or not it timed out however I wasn’t sure whether that was reasonable behaviour or not.</p> </blockquote> <p>Another simple example is testing the count of packets received.</p> <blockquote> <p>This may be difficult to guarantee as ports may receive packets for things like SSDP, multicast DNS, or any number of packets that may be sent to a port by the OS as a part of it’s normal operation</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">packet_count_was</span><span class="p">(</span><span class="n">async_packet_test</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_expected_count</span> <span class="o">=</span> <span class="n">count</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_received_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">on_packet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkt</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_received_count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">on_finish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timed_out</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">_received_count</span> <span class="o">==</span> <span class="bp">self</span><span class="p">.</span><span class="n">_expected_count</span>
</code></pre></div></div> <p>As each packet is received, a counter will be incremented. At the end of the time out period, the count will be compared with the expected result.</p> <blockquote> <p>The stop condition cannot be used for this purpose as it is called before the more general <code class="language-plaintext highlighter-rouge">on_packet</code> function.</p> </blockquote> <p>It is important to note differences in between behaviour. This test expects a specific number of packets, if the total count is off, it will return False. However, it could equally be written so that it terminates as soon as the number of packets are counted, that is to say, we care about the minimum number of packets received, and not the total. This could be written as follows:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">min_packet_count_was</span><span class="p">(</span><span class="n">async_packet_test</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_expected_count</span> <span class="o">=</span> <span class="n">count</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_received_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">stop_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkt</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_received_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">_received_count</span> <span class="o">==</span> <span class="bp">self</span><span class="p">.</span><span class="n">_expected_count</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>
</code></pre></div></div> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
